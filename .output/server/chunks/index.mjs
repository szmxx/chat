import{K as e}from"../index.mjs";import{defineHeadPlugin as s,tagDedupeKey as r,tagWeight as n,HasElementTags as a,hashCode as i,SortModifiers as p,processTemplateParams as l,resolveTitleTemplate as c,IsBrowser as d,normaliseEntryTags as g}from"@unhead/shared";const u=["templateParams","htmlAttrs","bodyAttrs"],f=s({hooks:{"tag:normalise":function({tag:e}){["hid","vmid","key"].forEach((s=>{e.props[s]&&(e.key=e.props[s],delete e.props[s])}));const s=r(e)||!!e.key&&`${e.tag}:${e.key}`;s&&(e._d=s)},"tags:resolve":function(e){const s={};e.tags.forEach((e=>{const r=(e.key?`${e.tag}:${e.key}`:e._d)||e._p,i=s[r];if(i){let a=e?.tagDuplicateStrategy;if(!a&&u.includes(e.tag)&&(a="merge"),"merge"===a){const n=i.props;return["class","style"].forEach((s=>{e.props[s]&&n[s]&&("style"===s&&!n[s].endsWith(";")&&(n[s]+=";"),e.props[s]=`${n[s]} ${e.props[s]}`)})),void(s[r].props={...n,...e.props})}if(e._e===i._e)return i._duped=i._duped||[],e._d=`${i._d}:${i._duped.length+1}`,void i._duped.push(e);if(n(e)>n(i))return}const p=Object.keys(e.props).length+(e.innerHTML?1:0)+(e.textContent?1:0);a.includes(e.tag)&&0===p?delete s[r]:s[r]=e}));const r=[];Object.values(s).forEach((e=>{const s=e._duped;delete e._duped,r.push(e),s&&r.push(...s)})),e.tags=r,e.tags=e.tags.filter((e=>!("meta"===e.tag&&(e.props.name||e.props.property)&&!e.props.content)))}}}),h=s({mode:"server",hooks:{"tags:resolve":function(e){const s={};e.tags.filter((e=>["titleTemplate","templateParams","title"].includes(e.tag)&&"server"===e._m)).forEach((e=>{s[e.tag]=e.tag.startsWith("title")?e.textContent:e.props})),Object.keys(s).length&&e.tags.push({tag:"script",innerHTML:JSON.stringify(s),props:{id:"unhead:payload",type:"application/json"}})}}}),y=["script","link","bodyAttrs"];function m(e){const s={},r={};return Object.entries(e.props).forEach((([e,n])=>{e.startsWith("on")&&"function"==typeof n?r[e]=n:s[e]=n})),{props:s,eventHandlers:r}}const k=s({hooks:{"ssr:render":function(e){e.tags=e.tags.map((e=>(!y.includes(e.tag)||!Object.entries(e.props).find((([e,s])=>e.startsWith("on")&&"function"==typeof s))||(e.props=m(e).props),e)))},"tags:resolve":function(e){e.tags=e.tags.map((e=>{if(!y.includes(e.tag))return e;const{props:s,eventHandlers:r}=m(e);return Object.keys(r).length&&(e.props=s,e._eventHandlers=r),e}))},"dom:renderTag":function(e,s,r){if(!e.tag._eventHandlers)return;const n="bodyAttrs"===e.tag.tag?s.defaultView:e.$el;Object.entries(e.tag._eventHandlers).forEach((([s,a])=>{const i=`${e.tag._d||e.tag._p}:${s}`,p=s.slice(2).toLowerCase(),l=`data-h-${p}`;if(r(e.id,i,(()=>{})),e.$el.hasAttribute(l))return;const c=a;e.$el.setAttribute(l,""),n.addEventListener(p,c),e.entry&&r(e.id,i,(()=>{n.removeEventListener(p,c),e.$el.removeAttribute(l)}))}))}}}),v=["link","style","script","noscript"],_=s({hooks:{"tag:normalise":({tag:e})=>{e.key&&v.includes(e.tag)&&(e.props["data-hid"]=e._h=i(e.key))}}}),H=s({hooks:{"tags:resolve":e=>{const o=s=>e.tags.find((e=>e._d===s))?._p;for(const{prefix:s,offset:r}of p)for(const n of e.tags.filter((e=>"string"==typeof e.tagPriority&&e.tagPriority.startsWith(s)))){const e=o(n.tagPriority.replace(s,""));typeof e<"u"&&(n._p=e+r)}e.tags.sort(((e,s)=>e._p-s._p)).sort(((e,s)=>n(e)-n(s)))}}}),C=s({hooks:{"tags:resolve":e=>{const{tags:s}=e,r=s.find((e=>"title"===e.tag))?.textContent,n=s.findIndex((e=>"templateParams"===e.tag)),a=-1!==n?s[n].props:{},i=a.separator||"|";delete a.separator,a.pageTitle=l(a.pageTitle||r||"",a,i);for(const e of s)!1!==e.processTemplateParams&&(["titleTemplate","title"].includes(e.tag)&&"string"==typeof e.textContent?e.textContent=l(e.textContent,a,i):"meta"===e.tag&&"string"==typeof e.props.content?e.props.content=l(e.props.content,a,i):"link"===e.tag&&"string"==typeof e.props.href?e.props.href=l(e.props.href,a,i):!0===e.processTemplateParams&&(e.innerHTML?e.innerHTML=l(e.innerHTML,a,i):e.textContent&&(e.textContent=l(e.textContent,a,i))));e.tags=s.filter((e=>"templateParams"!==e.tag))}}}),b=s({hooks:{"tags:resolve":e=>{const{tags:s}=e;let r=s.findIndex((e=>"titleTemplate"===e.tag));const n=s.findIndex((e=>"title"===e.tag));if(-1!==n&&-1!==r){const e=c(s[r].textContent,s[n].textContent);null!==e?s[n].textContent=e||s[n].textContent:delete s[n]}else if(-1!==r){const e=c(s[r].textContent);null!==e&&(s[r].textContent=e,s[r].tag="title",r=-1)}-1!==r&&delete s[r],e.tags=s.filter(Boolean)}}});let $;function W(e={}){return $=T(e)}function P(e,s){return!e||"server"===e&&s||"client"===e&&!s}function T(s={}){const r=e();r.addHooks(s.hooks||{}),s.document=s.document||(d?document:void 0);const n=!s.document;s.plugins=[f,h,k,_,H,C,b,...s?.plugins||[]];const t=()=>{p.dirty=!0,r.callHook("entries:updated",p)};let a=0,i=[];const p={dirty:!1,resolvedOptions:s,hooks:r,headEntries:()=>i,use(e){const s="function"==typeof e?e(p):e;P(s.mode,n)&&r.addHooks(s.hooks||{})},push(e,s){delete s?.head;const l={_i:a++,input:e,...s};return P(l.mode,n)&&(i.push(l),t()),{dispose(){i=i.filter((e=>e._i!==l._i)),r.callHook("entries:updated",p),t()},patch(e){i=i.map((s=>(s._i===l._i&&(s.input=l.input=e),s))),t()}}},async resolveTags(){const e={tags:[],entries:[...i]};await r.callHook("entries:resolve",e);for(const s of e.entries){const n=s.resolvedInput||s.input;if(s.resolvedInput=await(s.transform?s.transform(n):n),s.resolvedInput)for(const n of await g(s)){const a={tag:n,entry:s,resolvedOptions:p.resolvedOptions};await r.callHook("tag:normalise",a),e.tags.push(a.tag)}}return await r.callHook("tags:beforeResolve",e),await r.callHook("tags:resolve",e),e.tags},ssr:n};return s.plugins.forEach((e=>p.use(e))),p.hooks.callHook("init",p),p}const E=/@import/;function x(e){return s({hooks:{"tags:beforeResolve":function({tags:s}){for(const e of s){if(e.tagPosition&&"head"!==e.tagPosition||(e.tagPriority=e.tagPriority||n(e),100!==e.tagPriority))continue;const t=e=>""===e||!0===e,s="script"===e.tag,r="link"===e.tag;s&&t(e.props.async)?e.tagPriority=30:"style"===e.tag&&e.innerHTML&&E.test(e.innerHTML)?e.tagPriority=40:!s||!e.props.src||t(e.props.defer)||t(e.props.async)||"module"===e.props.type||e.props.type?.endsWith("json")?r&&"stylesheet"===e.props.rel||"style"===e.tag?e.tagPriority=60:r&&["preload","modulepreload"].includes(e.props.rel)?e.tagPriority=70:s&&t(e.props.defer)&&e.props.src&&!t(e.props.async)?e.tagPriority=80:r&&["prefetch","dns-prefetch","prerender"].includes(e.props.rel)&&(e.tagPriority=90):e.tagPriority=50}e?.track&&s.push({tag:"htmlAttrs",props:{"data-capo":""}})}}})}function R(){return $}export{x as C,T as a,W as c,R as g};
